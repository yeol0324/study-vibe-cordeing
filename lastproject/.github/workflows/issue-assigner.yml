name: ì´ìŠˆ ìë™ í• ë‹¹

on:
  issues:
    types: [opened, reopened, labeled]

jobs:
  assign-issue:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì´ìŠˆ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.issue.number;
          const issueTitle = context.payload.issue.title.toLowerCase();
          const issueBody = context.payload.issue.body?.toLowerCase() || '';
          const issueLabels = context.payload.issue.labels.map(label => label.name);
          const author = context.payload.issue.user.login;
          
          // íŒ€ ë©¤ë²„ ì •ì˜ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            backend: ['backend-dev1', 'backend-dev2', 'fullstack-dev'],
            frontend: ['frontend-dev1', 'frontend-dev2', 'fullstack-dev'],
            docs: ['tech-writer', 'fullstack-dev', 'project-maintainer'],
            bug: ['qa-engineer', 'backend-dev1', 'frontend-dev1'],
            feature: ['product-manager', 'lead-dev', 'fullstack-dev'],
            security: ['security-engineer', 'backend-dev1'],
            performance: ['performance-engineer', 'backend-dev1'],
            urgent: ['lead-dev', 'project-maintainer'],
            default: ['project-maintainer', 'lead-dev']
          };
          
          let assignees = new Set();
          
          // ë¼ë²¨ ê¸°ë°˜ í• ë‹¹
          for (const label of issueLabels) {
            if (label.startsWith('area/')) {
              const area = label.replace('area/', '');
              if (teamMembers[area]) {
                const randomMember = teamMembers[area][Math.floor(Math.random() * teamMembers[area].length)];
                assignees.add(randomMember);
              }
            } else if (label.startsWith('type/')) {
              const type = label.replace('type/', '');
              if (teamMembers[type]) {
                const randomMember = teamMembers[type][Math.floor(Math.random() * teamMembers[type].length)];
                assignees.add(randomMember);
              }
            } else if (label.startsWith('priority/high') || label.includes('urgent')) {
              teamMembers.urgent.forEach(member => assignees.add(member));
            }
          }
          
          // í‚¤ì›Œë“œ ê¸°ë°˜ í• ë‹¹ (ë¼ë²¨ì´ ì—†ëŠ” ê²½ìš°)
          if (assignees.size === 0) {
            if (issueTitle.includes('backend') || issueBody.includes('api') || issueBody.includes('server')) {
              const randomMember = teamMembers.backend[Math.floor(Math.random() * teamMembers.backend.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('frontend') || issueBody.includes('ui') || issueBody.includes('streamlit')) {
              const randomMember = teamMembers.frontend[Math.floor(Math.random() * teamMembers.frontend.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('docs') || issueTitle.includes('documentation')) {
              const randomMember = teamMembers.docs[Math.floor(Math.random() * teamMembers.docs.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('bug') || issueTitle.includes('error') || issueTitle.includes('fail')) {
              const randomMember = teamMembers.bug[Math.floor(Math.random() * teamMembers.bug.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('feature') || issueTitle.includes('enhancement')) {
              const randomMember = teamMembers.feature[Math.floor(Math.random() * teamMembers.feature.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('security') || issueBody.includes('vulnerability')) {
              const randomMember = teamMembers.security[Math.floor(Math.random() * teamMembers.security.length)];
              assignees.add(randomMember);
            } else if (issueTitle.includes('performance') || issueTitle.includes('slow') || issueTitle.includes('optimization')) {
              const randomMember = teamMembers.performance[Math.floor(Math.random() * teamMembers.performance.length)];
              assignees.add(randomMember);
            }
          }
          
          // ê¸´ê¸‰í•œ ì´ìŠˆì¸ ê²½ìš° ì¶”ê°€ í• ë‹¹
          if (issueTitle.includes('urgent') || issueTitle.includes('critical') || issueTitle.includes('hotfix')) {
            teamMembers.urgent.forEach(member => assignees.add(member));
          }
          
          // ê¸°ë³¸ í• ë‹¹ (ë§¤ì¹­ë˜ëŠ” ê²ƒì´ ì—†ëŠ” ê²½ìš°)
          if (assignees.size === 0) {
            const randomDefault = teamMembers.default[Math.floor(Math.random() * teamMembers.default.length)];
            assignees.add(randomDefault);
          }
          
          // ì‘ì„±ìëŠ” ì œì™¸
          assignees.delete(author);
          
          // ìµœëŒ€ 2ëª…ê¹Œì§€ë§Œ í• ë‹¹
          const finalAssignees = Array.from(assignees).slice(0, 2);
          
          if (finalAssignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: finalAssignees
              });
              
              console.log(`ì´ìŠˆ í• ë‹¹ ì™„ë£Œ: ${finalAssignees.join(', ')}`);
              
              // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
              const assignMessage = `
              ## ğŸ‘¤ ë‹´ë‹¹ìê°€ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤
              
              í• ë‹¹ëœ ë‹´ë‹¹ì: ${finalAssignees.map(a => `@${a}`).join(', ')}
              
              **í• ë‹¹ ê¸°ì¤€:**
              ${issueLabels.length > 0 ? `- ë¼ë²¨: ${issueLabels.join(', ')}` : ''}
              ${issueTitle.includes('urgent') ? '- ê¸´ê¸‰ ì´ìŠˆë¡œ ë¶„ë¥˜ë¨' : ''}
              ${assignees.size > 2 ? '- ë³µìˆ˜ ì˜ì—­ ê´€ë ¨ìœ¼ë¡œ ì£¼ìš” ë‹´ë‹¹ìë§Œ í• ë‹¹' : ''}
              
              ### ğŸ“ ë‹´ë‹¹ì ì•ˆë‚´
              
              @${finalAssignees.join(' @')} ë‹˜ë“¤ê»˜:
              - ì´ìŠˆë¥¼ ê²€í† í•˜ê³  ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”
              - ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•˜ë©´ ì‘ì„±ìì—ê²Œ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”
              - ì‘ì—… ì‹œì‘ ì‹œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”
              
              ### ğŸ”„ ìƒíƒœ ê´€ë¦¬
              
              - **ë¶„ì„ ì¤‘**: ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤
              - **ì§„í–‰ ì¤‘**: ì‘ì—…ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤
              - **ë¸”ë¡œí‚¹**: ì™¸ë¶€ ìš”ì¸ìœ¼ë¡œ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤
              - **ì™„ë£Œ**: ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
              
              ë‹´ë‹¹ìê°€ ì ì ˆí•˜ì§€ ì•Šë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ì¬í• ë‹¹í•´ ì£¼ì„¸ìš”.
              `;
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: assignMessage
              });
              
            } catch (error) {
              console.log(`ì´ìŠˆ í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
              console.log('ì¼ë¶€ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              
              // í• ë‹¹ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ ëŒ“ê¸€
              const errorMessage = `
              ## âš ï¸ ìë™ í• ë‹¹ ì‹¤íŒ¨
              
              ë‹´ë‹¹ì ìë™ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ ì´ìœ ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
              
              - ì„¤ì •ëœ ì‚¬ìš©ìê°€ ì €ì¥ì†Œì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŒ
              - ì‚¬ìš©ìëª…ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
              - ì €ì¥ì†Œ ê¶Œí•œ ì„¤ì • ë¬¸ì œ
              
              **ì¶”ì²œ ë‹´ë‹¹ì**: ${finalAssignees.join(', ')}
              
              í”„ë¡œì íŠ¸ ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”.
              `;
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: errorMessage
              });
            }
          } else {
            console.log('í• ë‹¹ ê°€ëŠ¥í•œ ë‹´ë‹¹ìê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
  
  auto-escalate-urgent:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'urgent') || contains(github.event.issue.title, 'critical')
    
    steps:
    - name: ê¸´ê¸‰ ì´ìŠˆ ì—ìŠ¤ì»¬ë ˆì´ì…˜
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.issue.number;
          
          // ê¸´ê¸‰ ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            labels: ['priority/high', 'urgent']
          });
          
          // ì—ìŠ¤ì»¬ë ˆì´ì…˜ ëŒ“ê¸€
          const escalationMessage = `
          ## ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ ê°ì§€ë¨
          
          ì´ ì´ìŠˆëŠ” ê¸´ê¸‰ ì´ìŠˆë¡œ ë¶„ë¥˜ë˜ì–´ ìš°ì„ ìˆœìœ„ê°€ ë†’ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          **ìë™ ì²˜ë¦¬ ì‚¬í•­:**
          - \`priority/high\` ë° \`urgent\` ë¼ë²¨ ì¶”ê°€
          - í”„ë¡œì íŠ¸ ë¦¬ë”ì—ê²Œ ìë™ í• ë‹¹
          - ë†’ì€ ìš°ì„ ìˆœìœ„ë¡œ ì²˜ë¦¬ ì˜ˆì •
          
          **ì˜ˆìƒ ì‘ë‹µ ì‹œê°„**: 24ì‹œê°„ ì´ë‚´
          
          ì¶”ê°€ ì§€ì›ì´ í•„ìš”í•˜ì‹œë©´ ì¦‰ì‹œ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
          `;
          
          await github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: escalationMessage
          }); 