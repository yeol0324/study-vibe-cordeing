name: PR ì½”ë“œ ë¦¬ë·° ìë™ ë“±ë¡

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  automated-code-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ì½”ë“œ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort bandit mypy
        pip install -r backend/requirements.txt || true
    
    - name: ë³€ê²½ëœ Python íŒŒì¼ ì°¾ê¸°
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          *.py
          **/*.py
    
    - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (Black)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== Black í¬ë§· ì²´í¬ ===" > code_review_results.txt
        black --check --diff ${{ steps.changed-files.outputs.all_changed_files }} >> code_review_results.txt 2>&1 || echo "Black í¬ë§· ì´ìŠˆ ë°œê²¬" >> code_review_results.txt
        echo "" >> code_review_results.txt
      continue-on-error: true
    
    - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== isort Import ì •ë ¬ ì²´í¬ ===" >> code_review_results.txt
        isort --check-only --diff ${{ steps.changed-files.outputs.all_changed_files }} >> code_review_results.txt 2>&1 || echo "Import ì •ë ¬ ì´ìŠˆ ë°œê²¬" >> code_review_results.txt
        echo "" >> code_review_results.txt
      continue-on-error: true
    
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Flake8)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== Flake8 ì½”ë“œ í’ˆì§ˆ ì²´í¬ ===" >> code_review_results.txt
        flake8 ${{ steps.changed-files.outputs.all_changed_files }} --max-line-length=88 --extend-ignore=E203,W503 >> code_review_results.txt 2>&1 || echo "Flake8 ì´ìŠˆ ë°œê²¬" >> code_review_results.txt
        echo "" >> code_review_results.txt
      continue-on-error: true
    
    - name: ë³´ì•ˆ ê²€ì‚¬ (Bandit)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== Bandit ë³´ì•ˆ ê²€ì‚¬ ===" >> code_review_results.txt
        bandit -r ${{ steps.changed-files.outputs.all_changed_files }} -f txt >> code_review_results.txt 2>&1 || echo "ë³´ì•ˆ ì´ìŠˆ ë°œê²¬" >> code_review_results.txt
        echo "" >> code_review_results.txt
      continue-on-error: true
    
    - name: íƒ€ì… ê²€ì‚¬ (MyPy)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== MyPy íƒ€ì… ì²´í¬ ===" >> code_review_results.txt
        mypy ${{ steps.changed-files.outputs.all_changed_files }} --ignore-missing-imports >> code_review_results.txt 2>&1 || echo "íƒ€ì… ê²€ì‚¬ ì´ìŠˆ ë°œê²¬" >> code_review_results.txt
        echo "" >> code_review_results.txt
      continue-on-error: true
    
    - name: ë³µì¡ë„ ë¶„ì„
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== ì½”ë“œ ë³µì¡ë„ ë¶„ì„ ===" >> code_review_results.txt
        python -c "
        import ast
        import sys
        
        def analyze_complexity(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    tree = ast.parse(f.read())
                
                functions = []
                classes = []
                
                for node in ast.walk(tree):
                    if isinstance(node, ast.FunctionDef):
                        # í•¨ìˆ˜ ë³µì¡ë„ ê³„ì‚° (ê°„ë‹¨í•œ ë²„ì „)
                        complexity = len([n for n in ast.walk(node) if isinstance(n, (ast.If, ast.For, ast.While, ast.Try))])
                        if complexity > 5:
                            functions.append(f'  - {node.name}() í•¨ìˆ˜: ë³µì¡ë„ {complexity} (ê¶Œì¥: 5 ì´í•˜)')
                    
                    elif isinstance(node, ast.ClassDef):
                        method_count = len([n for n in node.body if isinstance(n, ast.FunctionDef)])
                        if method_count > 10:
                            classes.append(f'  - {node.name} í´ë˜ìŠ¤: ë©”ì†Œë“œ {method_count}ê°œ (ê¶Œì¥: 10ê°œ ì´í•˜)')
                
                if functions or classes:
                    print(f'{file_path}:')
                    for func in functions:
                        print(func)
                    for cls in classes:
                        print(cls)
                    print()
                        
            except Exception as e:
                print(f'{file_path}: ë¶„ì„ ì‹¤íŒ¨ - {e}')
        
        files = '${{ steps.changed-files.outputs.all_changed_files }}'.split()
        for file_path in files:
            if file_path.endswith('.py'):
                analyze_complexity(file_path)
        " >> code_review_results.txt 2>&1
      continue-on-error: true
    
    - name: ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const prNumber = context.payload.pull_request.number;
          
          let reviewResults = '';
          try {
            reviewResults = fs.readFileSync('code_review_results.txt', 'utf8');
          } catch (error) {
            reviewResults = 'ì½”ë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          }
          
          // ë³€ê²½ëœ íŒŒì¼ ìˆ˜ ê³„ì‚°
          const changedFileCount = '${{ steps.changed-files.outputs.all_changed_files_count }}';
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ').filter(f => f.endsWith('.py'));
          
          // ë¦¬ë·° ìš”ì•½ ìƒì„±
          const hasBlackIssues = reviewResults.includes('Black í¬ë§· ì´ìŠˆ');
          const hasIsortIssues = reviewResults.includes('Import ì •ë ¬ ì´ìŠˆ');
          const hasFlake8Issues = reviewResults.includes('Flake8 ì´ìŠˆ');
          const hasSecurityIssues = reviewResults.includes('ë³´ì•ˆ ì´ìŠˆ');
          const hasTypeIssues = reviewResults.includes('íƒ€ì… ê²€ì‚¬ ì´ìŠˆ');
          
          const issueCount = [hasBlackIssues, hasIsortIssues, hasFlake8Issues, hasSecurityIssues, hasTypeIssues].filter(Boolean).length;
          
          let reviewStatus = 'âœ… ëª¨ë“  ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!';
          let reviewIcon = 'âœ…';
          
          if (issueCount > 3) {
            reviewStatus = 'âŒ ì—¬ëŸ¬ ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            reviewIcon = 'âŒ';
          } else if (issueCount > 0) {
            reviewStatus = 'âš ï¸ ì¼ë¶€ ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ ì£¼ì„¸ìš”.';
            reviewIcon = 'âš ï¸';
          }
          
          const reviewComment = `
          ## ${reviewIcon} ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼
          
          **ë¶„ì„ ëŒ€ìƒ**: ${changedFiles.length}ê°œ Python íŒŒì¼
          **ìƒíƒœ**: ${reviewStatus}
          
          ### ğŸ“Š ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
          
          | ê²€ì‚¬ í•­ëª© | ìƒíƒœ |
          |-----------|------|
          | ì½”ë“œ í¬ë§· (Black) | ${hasBlackIssues ? 'âŒ ì´ìŠˆ ë°œê²¬' : 'âœ… í†µê³¼'} |
          | Import ì •ë ¬ (isort) | ${hasIsortIssues ? 'âŒ ì´ìŠˆ ë°œê²¬' : 'âœ… í†µê³¼'} |
          | ì½”ë“œ í’ˆì§ˆ (Flake8) | ${hasFlake8Issues ? 'âŒ ì´ìŠˆ ë°œê²¬' : 'âœ… í†µê³¼'} |
          | ë³´ì•ˆ ê²€ì‚¬ (Bandit) | ${hasSecurityIssues ? 'âŒ ì´ìŠˆ ë°œê²¬' : 'âœ… í†µê³¼'} |
          | íƒ€ì… ê²€ì‚¬ (MyPy) | ${hasTypeIssues ? 'âŒ ì´ìŠˆ ë°œê²¬' : 'âœ… í†µê³¼'} |
          
          <details>
          <summary>ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼ (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)</summary>
          
          \`\`\`
          ${reviewResults}
          \`\`\`
          
          </details>
          
          ### ğŸ› ï¸ ìˆ˜ì • ë°©ë²•
          
          ${hasBlackIssues ? '- **í¬ë§· ìˆ˜ì •**: `black .` ëª…ë ¹ì–´ë¡œ ì½”ë“œ í¬ë§·ì„ ìë™ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' : ''}
          ${hasIsortIssues ? '- **Import ì •ë ¬**: `isort .` ëª…ë ¹ì–´ë¡œ import ìˆœì„œë¥¼ ìë™ ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' : ''}
          ${hasFlake8Issues ? '- **ì½”ë“œ í’ˆì§ˆ**: Flake8 ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.\n' : ''}
          ${hasSecurityIssues ? '- **ë³´ì•ˆ ì´ìŠˆ**: Banditì´ ë°œê²¬í•œ ë³´ì•ˆ ì·¨ì•½ì ì„ ê²€í† í•˜ê³  ìˆ˜ì •í•´ ì£¼ì„¸ìš”.\n' : ''}
          ${hasTypeIssues ? '- **íƒ€ì… íŒíŠ¸**: MyPy ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê³  íƒ€ì… íŒíŠ¸ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.\n' : ''}
          
          ### ğŸ’¡ ì¶”ì²œ ì‚¬í•­
          - ë¡œì»¬ì—ì„œ pre-commit hookì„ ì„¤ì •í•˜ì—¬ ìë™ìœ¼ë¡œ ê²€ì‚¬í•˜ì„¸ìš”
          - IDE í™•ì¥ í”„ë¡œê·¸ë¨ì„ í™œìš©í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ ì´ìŠˆë¥¼ í™•ì¸í•˜ì„¸ìš”
          - ì½”ë“œ ë¦¬ë·° ì „ì— ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤
          
          ---
          
          ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ íŒ€ì›ì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.
          `;
          
          await github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reviewComment
          });
          
          // ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë§ìœ¼ë©´ ë¦¬ë·° ìš”ì²­ ìƒíƒœë¡œ ì„¤ì •
          if (issueCount > 2) {
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: `ìë™ ì½”ë“œ ë¦¬ë·°ì—ì„œ ${issueCount}ê°œì˜ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ìš”ì²­í•´ ì£¼ì„¸ìš”.`,
                event: 'REQUEST_CHANGES'
              });
            } catch (error) {
              console.log('ë¦¬ë·° ìƒíƒœ ì„¤ì • ì‹¤íŒ¨:', error.message);
            }
          } 