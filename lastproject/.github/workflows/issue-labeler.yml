name: ì´ìŠˆ ë¼ë²¨ ìë™ ë“±ë¡

on:
  issues:
    types: [opened, reopened, edited]

jobs:
  label-issue:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì´ìŠˆ ìë™ ë¼ë²¨ë§
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.issue.number;
          const issueTitle = context.payload.issue.title.toLowerCase();
          const issueBody = context.payload.issue.body?.toLowerCase() || '';
          const labels = new Set();
          
          // íƒ€ì… ë¼ë²¨ë§ (ì œëª© ê¸°ë°˜)
          if (issueTitle.includes('bug') || issueTitle.includes('error') || issueTitle.includes('fail') || 
              issueBody.includes('error') || issueBody.includes('exception') || issueBody.includes('crash')) {
            labels.add('type/bug');
          } else if (issueTitle.includes('feature') || issueTitle.includes('enhancement') || issueTitle.includes('add') ||
                     issueBody.includes('feature request') || issueBody.includes('new feature')) {
            labels.add('type/feature');
          } else if (issueTitle.includes('docs') || issueTitle.includes('documentation') || issueTitle.includes('readme') ||
                     issueBody.includes('documentation') || issueBody.includes('guide')) {
            labels.add('type/documentation');
          } else if (issueTitle.includes('question') || issueTitle.includes('help') || issueTitle.includes('how') ||
                     issueBody.includes('question') || issueBody.includes('how to')) {
            labels.add('type/question');
          } else if (issueTitle.includes('refactor') || issueTitle.includes('improve') || issueTitle.includes('optimize') ||
                     issueBody.includes('refactoring') || issueBody.includes('optimization')) {
            labels.add('type/enhancement');
          } else if (issueTitle.includes('test') || issueTitle.includes('testing') ||
                     issueBody.includes('test') || issueBody.includes('testing')) {
            labels.add('type/test');
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ë§
          if (issueTitle.includes('urgent') || issueTitle.includes('critical') || issueTitle.includes('emergency') ||
              issueTitle.includes('hotfix') || issueBody.includes('urgent') || issueBody.includes('critical')) {
            labels.add('priority/high');
          } else if (issueTitle.includes('important') || issueTitle.includes('major') ||
                     issueBody.includes('important') || issueBody.includes('blocking')) {
            labels.add('priority/medium');
          } else {
            labels.add('priority/low');
          }
          
          // ì˜ì—­ ë¼ë²¨ë§ (í‚¤ì›Œë“œ ê¸°ë°˜)
          if (issueTitle.includes('backend') || issueTitle.includes('api') || issueTitle.includes('server') ||
              issueBody.includes('backend') || issueBody.includes('fastapi') || issueBody.includes('api') ||
              issueBody.includes('server') || issueBody.includes('database')) {
            labels.add('area/backend');
          }
          
          if (issueTitle.includes('frontend') || issueTitle.includes('ui') || issueTitle.includes('streamlit') ||
              issueBody.includes('frontend') || issueBody.includes('streamlit') || issueBody.includes('ui') ||
              issueBody.includes('interface') || issueBody.includes('user interface')) {
            labels.add('area/frontend');
          }
          
          if (issueTitle.includes('agent') || issueTitle.includes('langgraph') || issueTitle.includes('llm') ||
              issueBody.includes('agent') || issueBody.includes('langgraph') || issueBody.includes('gemini') ||
              issueBody.includes('llm') || issueBody.includes('ai')) {
            labels.add('area/agent');
          }
          
          if (issueTitle.includes('docs') || issueTitle.includes('documentation') || issueTitle.includes('readme') ||
              issueBody.includes('documentation') || issueBody.includes('readme') || issueBody.includes('guide')) {
            labels.add('area/docs');
          }
          
          if (issueTitle.includes('test') || issueTitle.includes('testing') ||
              issueBody.includes('test') || issueBody.includes('testing') || issueBody.includes('pytest')) {
            labels.add('area/tests');
          }
          
          if (issueTitle.includes('config') || issueTitle.includes('setup') || issueTitle.includes('installation') ||
              issueBody.includes('configuration') || issueBody.includes('setup') || issueBody.includes('install')) {
            labels.add('area/config');
          }
          
          // ì»´í¬ë„ŒíŠ¸ ë¼ë²¨ë§ (ì„¸ë¶€ ì˜ì—­)
          if (issueBody.includes('router') || issueBody.includes('endpoint') || issueBody.includes('/api/')) {
            labels.add('component/api');
          }
          
          if (issueBody.includes('model') || issueBody.includes('schema') || issueBody.includes('pydantic')) {
            labels.add('component/models');
          }
          
          if (issueBody.includes('service') || issueBody.includes('business logic')) {
            labels.add('component/services');
          }
          
          if (issueBody.includes('agent') || issueBody.includes('langgraph')) {
            labels.add('component/agents');
          }
          
          // ìƒíƒœ ë¼ë²¨ë§
          if (issueTitle.includes('wip') || issueTitle.includes('work in progress') ||
              issueBody.includes('work in progress') || issueBody.includes('ì§„í–‰ì¤‘')) {
            labels.add('status/in-progress');
          }
          
          if (issueBody.includes('blocked') || issueBody.includes('waiting') ||
              issueBody.includes('dependency') || issueBody.includes('ì°¨ë‹¨')) {
            labels.add('status/blocked');
          }
          
          // íŠ¹ë³„ ë¼ë²¨ë§
          if (issueBody.includes('security') || issueBody.includes('vulnerability') || issueBody.includes('ë³´ì•ˆ') ||
              issueTitle.includes('security') || issueTitle.includes('vulnerability')) {
            labels.add('security');
          }
          
          if (issueBody.includes('performance') || issueBody.includes('slow') || issueBody.includes('optimization') ||
              issueBody.includes('ì„±ëŠ¥') || issueTitle.includes('performance') || issueTitle.includes('slow')) {
            labels.add('performance');
          }
          
          if (issueBody.includes('breaking change') || issueBody.includes('breaking') ||
              issueTitle.includes('breaking')) {
            labels.add('breaking-change');
          }
          
          if (issueTitle.includes('duplicate') || issueBody.includes('duplicate') ||
              issueBody.includes('already exists') || issueBody.includes('ì¤‘ë³µ')) {
            labels.add('duplicate');
          }
          
          // í”Œë«í¼/í™˜ê²½ ë¼ë²¨ë§
          if (issueBody.includes('windows') || issueBody.includes('win32')) {
            labels.add('platform/windows');
          } else if (issueBody.includes('linux') || issueBody.includes('ubuntu')) {
            labels.add('platform/linux');
          } else if (issueBody.includes('macos') || issueBody.includes('mac')) {
            labels.add('platform/macos');
          }
          
          // ë¸Œë¼ìš°ì € ê´€ë ¨
          if (issueBody.includes('chrome') || issueBody.includes('firefox') || issueBody.includes('safari') ||
              issueBody.includes('edge') || issueBody.includes('browser')) {
            labels.add('browser-specific');
          }
          
          // ì²« ë²ˆì§¸ ì´ìŠˆì¸ì§€ í™•ì¸ (ìƒˆ ê¸°ì—¬ì)
          try {
            const { data: userIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: context.payload.issue.user.login,
              state: 'all'
            });
            
            if (userIssues.length === 1) {
              labels.add('good first issue');
              labels.add('first-time-contributor');
            }
          } catch (error) {
            console.log('ì²« ê¸°ì—¬ì í™•ì¸ ì‹¤íŒ¨:', error.message);
          }
          
          // ë¼ë²¨ ì ìš©
          const labelsArray = Array.from(labels);
          if (labelsArray.length > 0) {
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labelsArray
              });
              
              console.log(`ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ: ${labelsArray.join(', ')}`);
              
              // ë¼ë²¨ë§ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
              const labelMessage = `
              ## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
              
              ì¶”ê°€ëœ ë¼ë²¨:
              ${labelsArray.map(label => `\`${label}\``).join(', ')}
              
              ### ğŸ“Š ë¼ë²¨ ë¶„ë¥˜:
              
              **íƒ€ì…**: ${labelsArray.filter(l => l.startsWith('type/')).join(', ') || 'ë¯¸ë¶„ë¥˜'}
              **ì˜ì—­**: ${labelsArray.filter(l => l.startsWith('area/')).join(', ') || 'ì¼ë°˜'}
              **ìš°ì„ ìˆœìœ„**: ${labelsArray.filter(l => l.startsWith('priority/')).join(', ') || 'priority/low'}
              **íŠ¹ë³„ ë¼ë²¨**: ${labelsArray.filter(l => !l.startsWith('type/') && !l.startsWith('area/') && !l.startsWith('priority/')).join(', ') || 'ì—†ìŒ'}
              
              ### ğŸ’¡ ë¼ë²¨ í™œìš©ë²•:
              - **í•„í„°ë§**: ë¼ë²¨ì„ í´ë¦­í•˜ì—¬ ê´€ë ¨ ì´ìŠˆë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              - **ê²€ìƒ‰**: \`label:"ë¼ë²¨ëª…"\`ìœ¼ë¡œ íŠ¹ì • ë¼ë²¨ì˜ ì´ìŠˆë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              - **ìˆ˜ì •**: ë¼ë²¨ì´ ì˜ëª»ë˜ì—ˆë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”
              
              ${labelsArray.includes('good first issue') ? `
              ### ğŸ‰ ì²« ê¸°ì—¬ë¥¼ í™˜ì˜í•©ë‹ˆë‹¤!
              
              ì²« ë²ˆì§¸ ì´ìŠˆë¥¼ ì‘ì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•´ ì£¼ì…”ì„œ ì •ë§ ê¸°ì©ë‹ˆë‹¤!
              
              **ì‹ ê·œ ê¸°ì—¬ì ì•ˆë‚´:**
              - [ê¸°ì—¬ ê°€ì´ë“œ](../CONTRIBUTING.md)ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”
              - ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”
              - ì»¤ë®¤ë‹ˆí‹°ì˜ ë„ì›€ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤
              ` : ''}
              
              ë¼ë²¨ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
              `;
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: labelMessage
              });
              
            } catch (error) {
              console.log(`ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
            }
          } else {
            console.log('ì¶”ê°€í•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.');
          }

  milestone-assignment:
    runs-on: ubuntu-latest
    needs: label-issue
    
    steps:
    - name: ë§ˆì¼ìŠ¤í†¤ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.issue.number;
          const issueLabels = context.payload.issue.labels.map(label => label.name);
          
          // ë§ˆì¼ìŠ¤í†¤ ë§¤í•‘ (ì‹¤ì œ ë§ˆì¼ìŠ¤í†¤ IDë¡œ ë³€ê²½ í•„ìš”)
          const milestoneMapping = {
            'priority/high': 'v1.0.0 - Critical Fixes',
            'type/bug': 'v1.0.1 - Bug Fixes',
            'type/feature': 'v1.1.0 - New Features',
            'area/backend': 'Backend Development',
            'area/frontend': 'Frontend Development',
            'area/docs': 'Documentation',
            'security': 'Security Updates',
            'performance': 'Performance Improvements'
          };
          
          // ì ìš©í•  ë§ˆì¼ìŠ¤í†¤ ì°¾ê¸°
          let targetMilestone = null;
          
          for (const label of issueLabels) {
            if (milestoneMapping[label]) {
              targetMilestone = milestoneMapping[label];
              break; // ì²« ë²ˆì§¸ ë§¤ì¹­ë˜ëŠ” ë§ˆì¼ìŠ¤í†¤ ì‚¬ìš©
            }
          }
          
          if (targetMilestone) {
            try {
              // ë§ˆì¼ìŠ¤í†¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
              const { data: milestones } = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const milestone = milestones.find(m => m.title === targetMilestone);
              
              if (milestone) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  milestone: milestone.number
                });
                
                console.log(`ë§ˆì¼ìŠ¤í†¤ í• ë‹¹ ì™„ë£Œ: ${targetMilestone}`);
              } else {
                console.log(`ë§ˆì¼ìŠ¤í†¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${targetMilestone}`);
              }
            } catch (error) {
              console.log(`ë§ˆì¼ìŠ¤í†¤ í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
            }
          } 