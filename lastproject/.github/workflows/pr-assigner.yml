name: PR ìë™ í• ë‹¹

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: PR ì‘ì„±ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      id: pr-info
      run: |
        echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
        echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
    
    - name: ë³€ê²½ëœ íŒŒì¼ í™•ì¸
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          backend/**
          frontend/**
          docs/**
        files_yaml: |
          backend:
            - 'backend/**'
          frontend:
            - 'frontend/**'
          docs:
            - 'docs/**'
          tests:
            - '**/test_*.py'
            - '**/tests/**'
    
    - name: ë¦¬ë·°ì–´ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          
          // í”„ë¡œì íŠ¸ íŒ€ ë©¤ë²„ ì •ì˜ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            backend: ['backend-dev1', 'backend-dev2', 'fullstack-dev'],
            frontend: ['frontend-dev1', 'frontend-dev2', 'fullstack-dev'],
            docs: ['tech-writer', 'fullstack-dev'],
            tests: ['qa-engineer', 'backend-dev1'],
            default: ['project-maintainer', 'lead-dev']
          };
          
          // ë³€ê²½ëœ íŒŒì¼ ì˜ì—­ í™•ì¸
          const changedFiles = {
            backend: '${{ steps.changed-files.outputs.backend_any_changed }}' === 'true',
            frontend: '${{ steps.changed-files.outputs.frontend_any_changed }}' === 'true',
            docs: '${{ steps.changed-files.outputs.docs_any_changed }}' === 'true',
            tests: '${{ steps.changed-files.outputs.tests_any_changed }}' === 'true'
          };
          
          // ë¦¬ë·°ì–´ ì„ íƒ ë¡œì§
          let reviewers = new Set();
          
          for (const [area, hasChanges] of Object.entries(changedFiles)) {
            if (hasChanges && teamMembers[area]) {
              // ê° ì˜ì—­ì—ì„œ ì‘ì„±ìê°€ ì•„ë‹Œ ì‚¬ëŒì„ ë¬´ì‘ìœ„ë¡œ ì„ íƒ
              const availableReviewers = teamMembers[area].filter(member => member !== author);
              if (availableReviewers.length > 0) {
                const randomReviewer = availableReviewers[Math.floor(Math.random() * availableReviewers.length)];
                reviewers.add(randomReviewer);
              }
            }
          }
          
          // íŠ¹ì • ì˜ì—­ ë³€ê²½ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¦¬ë·°ì–´ í• ë‹¹
          if (reviewers.size === 0) {
            const defaultReviewers = teamMembers.default.filter(member => member !== author);
            if (defaultReviewers.length > 0) {
              reviewers.add(defaultReviewers[0]);
            }
          }
          
          // ìµœëŒ€ 3ëª…ê¹Œì§€ë§Œ í• ë‹¹
          const finalReviewers = Array.from(reviewers).slice(0, 3);
          
          if (finalReviewers.length > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                reviewers: finalReviewers
              });
              
              console.log(`ë¦¬ë·°ì–´ í• ë‹¹ ì™„ë£Œ: ${finalReviewers.join(', ')}`);
              
              // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
              const assignMessage = `
              ## ğŸ‘¥ ë¦¬ë·°ì–´ê°€ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤
              
              í• ë‹¹ëœ ë¦¬ë·°ì–´: ${finalReviewers.map(r => `@${r}`).join(', ')}
              
              ë³€ê²½ ì˜ì—­:
              ${Object.entries(changedFiles)
                .filter(([_, changed]) => changed)
                .map(([area, _]) => `- ${area}`)
                .join('\n') || '- ê¸°íƒ€'}
              `;
              
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: assignMessage
              });
              
            } catch (error) {
              console.log(`ë¦¬ë·°ì–´ í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
              console.log('ì¼ë¶€ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
          } else {
            console.log('í• ë‹¹ ê°€ëŠ¥í•œ ë¦¬ë·°ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
    
    - name: PR ì‘ì„±ìì—ê²Œ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          
          try {
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              assignees: [author]
            });
            
            console.log(`PR ì‘ì„±ì ${author}ë¥¼ assigneeë¡œ í• ë‹¹í–ˆìŠµë‹ˆë‹¤.`);
          } catch (error) {
            console.log(`Assignee í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
          } 