name: PR ë¼ë²¨ ìë™ ë“±ë¡

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          backend:
            - 'backend/**/*.py'
          frontend:
            - 'frontend/**/*.py'
          docs:
            - 'docs/**'
            - '*.md'
            - '**/*.md'
          tests:
            - '**/test_*.py'
            - '**/tests/**'
          config:
            - '*.yml'
            - '*.yaml'
            - '*.json'
            - '.github/**'
            - 'requirements.txt'
            - '*.toml'
          api:
            - 'backend/app/routers/**'
            - 'backend/app/api/**'
          models:
            - 'backend/app/models/**'
          services:
            - 'backend/app/services/**'
          agents:
            - 'backend/app/agents/**'
    
    - name: PR ì œëª©ê³¼ ë‚´ìš© ë¶„ì„í•˜ì—¬ ë¼ë²¨ ì¶”ê°€
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const prTitle = context.payload.pull_request.title.toLowerCase();
          const prBody = context.payload.pull_request.body?.toLowerCase() || '';
          const labels = new Set();
          
          // ë³€ê²½ëœ íŒŒì¼ ê¸°ë°˜ ë¼ë²¨ë§
          const changedFiles = {
            backend: '${{ steps.changed-files.outputs.backend_any_changed }}' === 'true',
            frontend: '${{ steps.changed-files.outputs.frontend_any_changed }}' === 'true',
            docs: '${{ steps.changed-files.outputs.docs_any_changed }}' === 'true',
            tests: '${{ steps.changed-files.outputs.tests_any_changed }}' === 'true',
            config: '${{ steps.changed-files.outputs.config_any_changed }}' === 'true',
            api: '${{ steps.changed-files.outputs.api_any_changed }}' === 'true',
            models: '${{ steps.changed-files.outputs.models_any_changed }}' === 'true',
            services: '${{ steps.changed-files.outputs.services_any_changed }}' === 'true',
            agents: '${{ steps.changed-files.outputs.agents_any_changed }}' === 'true'
          };
          
          // ì˜ì—­ë³„ ë¼ë²¨ ì¶”ê°€
          if (changedFiles.backend) labels.add('area/backend');
          if (changedFiles.frontend) labels.add('area/frontend');
          if (changedFiles.docs) labels.add('area/docs');
          if (changedFiles.tests) labels.add('area/tests');
          if (changedFiles.config) labels.add('area/config');
          if (changedFiles.api) labels.add('component/api');
          if (changedFiles.models) labels.add('component/models');
          if (changedFiles.services) labels.add('component/services');
          if (changedFiles.agents) labels.add('component/agents');
          
          // PR ì œëª© ê¸°ë°˜ íƒ€ì… ë¼ë²¨ë§
          if (prTitle.includes('[feat]') || prTitle.includes('feature') || prTitle.includes('add')) {
            labels.add('type/feature');
          } else if (prTitle.includes('[fix]') || prTitle.includes('bug') || prTitle.includes('error')) {
            labels.add('type/bug');
          } else if (prTitle.includes('[docs]') || prTitle.includes('documentation')) {
            labels.add('type/documentation');
          } else if (prTitle.includes('[refactor]') || prTitle.includes('refactoring')) {
            labels.add('type/refactoring');
          } else if (prTitle.includes('[test]') || prTitle.includes('testing')) {
            labels.add('type/test');
          } else if (prTitle.includes('[chore]') || prTitle.includes('maintenance')) {
            labels.add('type/chore');
          } else if (prTitle.includes('[style]') || prTitle.includes('formatting')) {
            labels.add('type/style');
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ë§ (ì œëª©ê³¼ ë‚´ìš© ë¶„ì„)
          if (prTitle.includes('urgent') || prTitle.includes('critical') || prTitle.includes('hotfix')) {
            labels.add('priority/high');
          } else if (prTitle.includes('important') || prBody.includes('breaking change')) {
            labels.add('priority/medium');
          } else {
            labels.add('priority/low');
          }
          
          // í¬ê¸° ë¼ë²¨ë§ (ë³€ê²½ëœ íŒŒì¼ ìˆ˜ ê¸°ë°˜)
          const changedFileCount = '${{ steps.changed-files.outputs.all_changed_files_count }}';
          if (parseInt(changedFileCount) > 20) {
            labels.add('size/XL');
          } else if (parseInt(changedFileCount) > 10) {
            labels.add('size/L');
          } else if (parseInt(changedFileCount) > 5) {
            labels.add('size/M');
          } else if (parseInt(changedFileCount) > 1) {
            labels.add('size/S');
          } else {
            labels.add('size/XS');
          }
          
          // íŠ¹ë³„í•œ ê²½ìš° ë¼ë²¨ë§
          if (prBody.includes('breaking change') || prTitle.includes('breaking')) {
            labels.add('breaking-change');
          }
          
          if (prTitle.includes('wip') || prTitle.includes('work in progress') || context.payload.pull_request.draft) {
            labels.add('status/wip');
          }
          
          if (prBody.includes('needs review') || prBody.includes('ready for review')) {
            labels.add('status/ready-for-review');
          }
          
          // ë¼ë²¨ ì ìš©
          const labelsArray = Array.from(labels);
          if (labelsArray.length > 0) {
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: labelsArray
              });
              
              console.log(`ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ: ${labelsArray.join(', ')}`);
              
              // ë¼ë²¨ë§ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
              const labelMessage = `
              ## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
              
              ì¶”ê°€ëœ ë¼ë²¨:
              ${labelsArray.map(label => `\`${label}\``).join(', ')}
              
              ### ë¼ë²¨ ì„¤ëª…:
              - **ì˜ì—­ ë¼ë²¨**: ë³€ê²½ëœ ì½”ë“œ ì˜ì—­
              - **íƒ€ì… ë¼ë²¨**: PRì˜ ìœ í˜• (feature, bug, docs ë“±)
              - **ìš°ì„ ìˆœìœ„ ë¼ë²¨**: ì¤‘ìš”ë„ ìˆ˜ì¤€
              - **í¬ê¸° ë¼ë²¨**: ë³€ê²½ ê·œëª¨ (íŒŒì¼ ìˆ˜ ê¸°ì¤€)
              
              ë¼ë²¨ì´ ì˜ëª» ì„¤ì •ë˜ì—ˆë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
              `;
              
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: labelMessage
              });
              
            } catch (error) {
              console.log(`ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
            }
          } else {
            console.log('ì¶”ê°€í•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.');
          } 